<div class='header'>
 <div class="header-left">
  <img src="{{ APP_LOGO }}" alt="{{ APP_LOGO_ALT }}" width="150">
{#
  <h2>{{ APP_NAME }}</h2>
  <h4>{{ APP_INFO }}</h4>
#}
 </div>
 {% if is_admin and rspamd_stats is not empty %}
 <div class="header-right">
  <div class='descr'>{#Rspamd Stats#}
  <button onclick="toggleDisplay('right-content', this)">Rspamd stats</button>
  </div>
  <div id='right-content' style='display:none;'>

  <table class='header-details'>
	<thead>
	<tr>
	<th>&nbsp;</th>
	{% for server in rspamd_stats|keys %}
<th>{{ server }}</th>
	{% endfor %}
<th>Total</th>
</tr>
	</thead>

<tbody>
{% set stat_keys = ['version', 'uptime', 'scanned', 'learned', 'spam_count', 'ham_count'] -%}

{# compute totals in advance #}
{% set totals = {} %}
{% for key in stat_keys %}
  {% set total = 0 %}
  {% for server in rspamd_stats|keys %}
    {% if rspamd_stats[server][key] is defined and key not in ['version','uptime'] %}
      {% set total = total + rspamd_stats[server][key] %}
    {% endif %}
  {% endfor %}
  {% set totals = totals|merge({ (key): total }) %}
{% endfor %}

{% for key in stat_keys -%}
<tr>
 <td><strong>{{ key|capitalize }}</strong></td>
 {% for server in rspamd_stats|keys -%}
 <td>{% if rspamd_stats[server][key] is defined -%}
  {% if key == 'uptime' -%}
   {% if rspamd_stats[server][key] > 86400 -%}
{{ (rspamd_stats[server][key] / 86400) | nf(1) }} days
	{% else -%}
{{ (rspamd_stats[server][key] / 3600) | nf(1) }} hours
	{% endif -%}
  {% elseif key == 'version' -%}
   {{- rspamd_stats[server][key] -}}
  {% else -%}
{{- rspamd_stats[server][key]|nf -}}
  {% endif -%}
 {% else -%}
  N/A
 {% endif -%}
 </td>
 {% endfor -%}

{# total column #}
 <td>
   {% if key in ['version','uptime'] %}
     â€”
   {% else %}
     {% set scanned_total = totals['scanned']|default(0) %}
     {% set val = totals[key]|default(0) %}
     {% if scanned_total > 0 and key not in ['scanned'] %}
       {{ val|nf }} ({{ (100 * val / scanned_total)|nf(1) }}%)
     {% else %}
       {{ val|nf }}
     {% endif %}
   {% endif %}
 </td>

</tr>
{% endfor -%}

{# Now print nested keys under 'actions' #}
{% set action_keys = ['no action', 'reject', 'rewrite subject', 'add header', 'greylist', 'soft reject'] -%}

{# precompute action totals #}
{% set action_totals = {} %}
{% for action_key in action_keys %}
  {% set total = 0 %}
  {% for server in rspamd_stats|keys %}
    {% if rspamd_stats[server]['actions'][action_key] is defined %}
      {% set total = total + rspamd_stats[server]['actions'][action_key] %}
    {% endif %}
  {% endfor %}
  {% set action_totals = action_totals|merge({ (action_key): total }) %}
{% endfor %}

{% for action_key in action_keys -%}
<tr>
 <td><strong>{{ action_key|capitalize }}</strong></td>
 {% for server in rspamd_stats|keys -%}
 <td>{% if rspamd_stats[server]['actions'] is defined and rspamd_stats[server]['actions'][action_key] is defined -%}
 {{- rspamd_stats[server]['actions'][action_key]|nf -}}
 {% else -%}
  N/A
 {% endif -%}
 </td>
{% endfor -%}

 <td>
   {% set scanned_total = totals['scanned']|default(0) %}
   {% set val = action_totals[action_key]|default(0) %}
   {% if scanned_total > 0 %}
     {{ val|nf }} ({{ (100 * val / scanned_total)|nf(1) }}%)
   {% else %}
     {{ val|nf }}
   {% endif %}
 </td>

</tr>
{% endfor -%}

</tbody>
</table>

  </div>
 </div>
{% endif %}
</div>

<script>
  function toggleDisplay(id, btn = null) {
    const el = document.getElementById(id);
    if (!el) return;

    if (el.style.display === 'none' || el.style.display === '') {
      el.style.display = 'block';
{#      if (btn) btn.textContent = 'Hide';#}
    } else {
      el.style.display = 'none';
{#      if (btn) btn.textContent = 'Show';#}
    }
  }
</script>
